
# Variables à modifier
PROG_NAME = clock
OS        = @os_name@

# Commandes
CXX  = g++
LD   = g++
ECHO = @echo_prog@

# Options du compilateur
COMMON_CXXFLAGS  = -pedantic -Wall -Wextra -O2 -g `pkg-config --cflags gtkmm-2.4`
LINUX_CXXFLAGS   = -DOS_IS_LINUX
WINDOWS_CXXFLAGS = -DOS_IS_WINDOWS
ifeq ($(OS), windows)
CXXFLAGS = $(COMMON_CXXFLAGS) $(WINDOWS_CXXFLAGS)
else ifeq ($(OS), linux)
CXXFLAGS = $(COMMON_CXXFLAGS) $(LINUX_CXXFLAGS)
else
CXXFLAGS = $(COMMON_CXXFLAGS)
endif
LDFLAGS   = `pkg-config --libs gtkmm-2.4`

# Fichiers à générer
ifeq ($(OS), windows)
EXE  = $(PROG_NAME).exe
else
EXE  = $(PROG_NAME)
endif
SRC  = $(wildcard *.cpp)
OBJS = $(patsubst %.cpp,%.o,$(SRC))
DEPS = $(patsubst %.cpp,%.dep,$(SRC))

all: $(EXE)

run: $(EXE)
	./$(EXE)

# Construction de l'exécutable à partir des .o
$(EXE): $(OBJS)
	@$(ECHO) "\033[34;1mLinking file $(notdir $@)...\033[0m"
	@$(LD) $^ -o $@ $(LDFLAGS)

# Construction des .o a partir des .cpp, et du fichier .dep correspondant
%.o: %.cpp %.dep
	@$(ECHO) "\033[34;1mCompiling file $(notdir $<)...\033[0m"
	@$(CXX) $(CXXFLAGS) -c -o $@ $<

# Construction des dépendances de chaque .cpp et de l'arborescence
%.dep: %.cpp
	@$(ECHO) "\033[34;1mExtracting dependencies from file $(notdir $<)...\033[0m"
	@$(CXX) $(CXXFLAGS) -MM -MF $@ $<

# Nettoyage
clean:
	rm -f *.o *.dep
	rm -f $(EXE)

# Nettoyage complet
distclean: clean
	rm -f config.*
	rm Makefile

# Dépendances générées dynamiquement
ifneq ($(MAKECMDGOALS), clean)
ifneq ($(MAKECMDGOALS), distclean)
-include $(DEPS)
endif
endif

# Cibles PHONY
.PHONY: clean run distclean
